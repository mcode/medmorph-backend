#!/usr/bin/env node

require('dotenv').config();
const axios = require('axios');

// step 1, check command line args
const args = process.argv.slice(2); // first 2 are "node add-server"
// console.log(args);

const newServer = {};

for (let i = 0 ; i < args.length ; i++) {
  const argKey = args[i];
  const argValue = args[++i];

  switch (argKey) {
    case '-e':
    case '--endpoint':
      newServer['endpoint'] = argValue;
      break;

    case '-t':
    case '--type':
      newServer['type'] = argValue;
      break;

    case '-c':
    case '--clientId':
      newServer['clientId'] = argValue;
      break;

    case '-n':
    case '--name':
      newServer['name'] = argValue;
      break;

    default:
      console.error(`Unknown command line option: ${argKey}`);
      console.error(`Full args: ${args}`);
      process.exit(1);
  }
}

if (!newServer['endpoint']) {
  console.error("Required argument -e|--endpoint missing!");
  process.exit(1);
}

if (!newServer['name']) {
  // if a name wasn't provided, use the endpoint URL as the name
  newServer['name'] = newServer['endpoint'];
}

const baseURL = process.env.BASE_URL;
// assumption is that BASE_URL does not contain a trailing /

const serversURL = baseURL + '/servers';

// see if the server is already running
// by hitting the base url.
// no connection = it's not running, add to DB directly
// connection succeeds = it's running, use the API
axios.get(serversURL, {
  headers: {
    'Authorization': 'Bearer admin'
  }
}).then(callApi).catch(addToDb);

function addToDb() {
  console.log('App not running. Adding server to db directly.');

  const servers = require('../src/storage/servers');
  // TODO: refactor this to use a better db post-init process
  setTimeout(() => {
    servers.addServer(newServer);
    setTimeout(() => {
      console.log('Added successfully.');
      process.exit(0);
    }, 10000);
  }, 10000);
}

function callApi() {
  try {
    console.log('App running. Adding server via api.');
    axios.post(serversURL, newServer, {
      headers: {
        'Authorization': 'Bearer admin'
      }
    })
      .then(() => console.log('Added successfully.'))
      .catch(e => console.log(e));
  } catch (e) {
    console.error(e);
  }
}